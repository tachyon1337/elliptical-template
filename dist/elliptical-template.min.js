!function(t,e){"undefined"!=typeof module&&module.exports?module.exports=e(require("elliptical-dustjs"),require("elliptical-scope"),require("elliptical-cache")):"function"==typeof define&&define.amd?define(["elliptical-dustjs","elliptical-scope","elliptical-cache"],e):t.returnExports=e(t.dust)}(this,function(t){window.dust=t;var e=$.elliptical.utils,n=e._;return"undefined"!=typeof window.dust&&$.widget.$providers({template:window.dust}),$.element("elliptical.template",[$.elliptical.scope,$.elliptical.cache],{_initElement:function(){this.options.setVisibility=this.options.setVisibility||!0,this.options.templateBind=this.options.templateBind||!0,"false"===this.options.templateBind&&(this.options.templateBind=!1),this._data.Running=null,this._data.unlockInterval=300,this._data._intervalId=null,this._data.fragment=null,this._data.templateId=null,this._data.tree=[],this._data.pathObservers=[],this._data._setDiscardBit=!0,this._data.modelPathTree=[],this._data.previouslyBound=!1,this._data._watched=!1;var t=this.options.$customElements;this._data.modelNodeSelector=t?"ui-model":'[data-node="model"]',this._data.attrId=t?"model-id":"data-id";var e=this.__getTemplateNode();e[0]&&this.options.templateBind&&(this._data.templateNode=e,this.__onScriptsLoaded())},__onScriptsLoaded:function(){var t=this;this._data._intervalId=setInterval(function(){void 0!==$$.fragments&&(clearInterval(t._data._intervalId),t.__bind())},100)},__bind:function(t){var e=this._data.templateNode;this.__initTemplate(e),this.__initDOMObserver(e[0]);var a=this.options.autoRender;this.__isModelList()?this.__scopeLength()>0?this.__databind(e,t,a):this.__watch(e,!0,t):n.isEmpty(this.$scope)?this.__watch(e,!1,t):this.__databind(e,t,a)},__watch:function(t,e,a){var i=this;this._data._watched=!0;var r=this.options.autoRender;this._data.intervalId=setInterval(function(){(e&&i.__scopeLength()>0||!e&&!n.isEmpty(i.$scope))&&(i._data._watched=!1,clearInterval(i._data.intervalId),i.__databind(t,a,r))},100)},__getTemplateNode:function(){return this.element.find("ui-template")},__initTemplate:function(t){var e,n=t.attr("id"),a=t.attr("name");"undefined"!=typeof n?(this._data.templateId=n,e=this.__getFragmentById(n),this._data.fragment=e,e&&this.__parseTemplateFragment(e)):"undefined"!=typeof a&&(this._data.templateId=a,e=this.__getFragmentByName(),this._data.fragment=e,e&&this.__parseTemplateFragment(e))},__initDOMObserver:function(t){var e=this,n=new MutationObserver(function(t){t.forEach(function(t){t.addedNodes&&t.addedNodes.length>0&&e.__addedNodes(t.addedNodes),t.removedNodes&&t.removedNodes.length>0&&e.__removedNodes(t.removedNodes),e._onDOMMutation(t)})});n.observe(t,{childList:!0,subtree:!0}),this._data.DOMObserver=n},__getFragmentById:function(t){var e;return!$$.fragments.length>0?null:($$.fragments.forEach(function(n){n.id===t&&(e=n.fragment)}),e)},__getFragmentByName:function(){var t=this._data.templateNode;return this.options.bindHTML5Imports&&this._renderElementTemplateImports(t),t.html()},__parseTemplateFragment:function(t){function e(t){t&&t.length&&t.forEach(function(t){if("#"===t[0]&&n.isArray(t)){var r={index:h,context:t[1][1],cxt:a(t[1][1],h,!1)};i=t[1][1],d.push(r),s.push(r);var o=h;h++,e(t),h=o}else"bodies"===t[0]?e(t[1]):"reference"===t[0]?e(t[1]):"body"===t[0]&&(t.forEach(function(t){if("reference"===t[0]){var e={cxt:a(i,h),context:i,index:h,key:t[1][1]};d.push(e)}}),e(t))})}function a(t,e,n){"undefined"==typeof n&&(n=!0),e>0&&n&&e--;var a=[];return s.forEach(function(t){t.index<e&&a.push(t.context)}),t&&a.push(t),a}var i,r=this.options.$providers.template,o=r.parse(t),s=[],d=[],h=0;o.length&&o.length>0&&e(o),d.push(s),this._data.contextKeyArray=d},__templateModels:function(t){"undefined"==typeof t&&(t=this._data.templateNode);var e=this._data.modelNodeSelector;return t?t.find(e):null},_templateNodes:function(){return this.__templateModels()},_nodeById:function(t){var e=this._templateNodes();return e.selfFind('[model-id="'+t+'"]')},__databind:function(t,e,a){this.__lock();var i=this,r=this.$scope,o=this.__templateModels(t);this.__isModelList()&&o&&o.length>0&&void 0===a?$.each(o,function(t,e){i.__bindModel(e,t)}):n.isEmpty(r)||void 0!==e?this.__bindModel(t[0],null):this.__render(r,function(){i.__databind(t,!1,void 0)}),this._data.previouslyBound=!0,this.__unlock(),i.__setVisibility(t)},__render:function(t,e){var n={};if(n.template=this._data.templateId,this.__isModelList()){var a=Object.keys(t)[0];n.model=t[a],n.context=a}else n.model=t;n.parse=!1,this.__renderTemplate(n,e)},__renderTemplate:function(t,e){var n=this,a=this._data.templateNode,i=this.$scope;this._renderTemplate(t,function(t,r){var o=r.replace(/<ui-template(.*?)>/g,"").replace(/<\/ui-template>/g,"");n._data.templateNode.html(o),n.options.bindHTML5Imports&&n._renderElementTemplateImports(a,i),e&&e(t,r)})},__lock:function(){this._data.Running=!0,this._data._setDiscardBit&&(this._data._discard=!0)},__unlock:function(){var t=this,e=this._data.unlockInterval;setTimeout(function(){t._data.Running=null,t._data._discard=!1,t._data._setDiscardBit=!0},e)},__setVisibility:function(t){this.options.autoRender&&this.options.setVisibility===!0&&this._setVisibility(t)},_setVisibility:function(t){void 0===t&&(t=this._data.templateNode),t.addClass("visible")},__bindModel:function(t,a){function i(t,e,n){var a=m.__getTemplateContextArray();a&&a.length>0&&a.forEach(function(a){if(a.index===t&&a.context===e){var i={index:t,context:a.context,cxt:a.cxt,modelIndex:n};x.push(i)}})}function r(){return x.length>0?x[x.length-1]:null}function o(t){var e=[],n=m.__getTemplateContextArray();return n&&n.length>0&&n.forEach(function(n){n.index===t&&e.push(n)}),e}function s(t){for(var e=0,n=P[0];t!==n;)t=$(t).parent()[0],("UI-MODEL"===t.tagName||t.hasAttribute("data-node"))&&e++;return e}function d(t){x.length>0&&n.remove(x,function(e){return e.index>t})}function h(){x.length=0}function _(t){if(t.tagName&&"ui-model"===t.tagName.toLowerCase()||t.hasAttribute&&t.hasAttribute("data-node")){b=s(t);var e=r();e&&e.index>b&&d(b);var n=0===b?m._data.templateNode[0]:$(t).parents(m._data.modelNodeSelector)[0];void 0===n&&(n=m._data.templateNode[0]);var a=$(n).closestChildren(m._data.modelNodeSelector).index($(t)),_=o(b),l={};_&&_.length>1?(l=m.__getCurrentContextModelPath(x,b,_,a),e&&b>e.index?(d(b),i(b,l.context,l.modelIndex)):(x.pop(),i(b,l.context,l.modelIndex))):e&&b>e.index?i(b,_[0].context,a):e?(x.pop(),i(b,_[0].context,a)):!e&&_.length>0&&i(b,_[0].context,a)}else{var n=$(t).parents(m._data.modelNodeSelector)[0];n?b=s(n):(b=0,h());var e=r();e&&e.index>b&&d(b)}(3!==t.nodeType&&t.hasAttributes()||t.tagName&&"ui-model"===t.tagName.toLowerCase())&&c(t)}function c(t){var e=m._data.scopeId;void 0===e&&(e="id");var n,a;$.each(t.attributes,function(i,r){try{if(r&&void 0!==r)if(0===r.name.indexOf("model")){n=e,a=r.name;var o=[a,n];p(t,o,r.value)}else if(0===r.name.indexOf("data-bind")){var s=r.value.split(",");s.length&&s.forEach(function(e){e=e.trim();var n=e.split(":"),a=n[0];"text"===a?l(t,n):p(t,n)})}}catch(d){console.log(d)}}),t.tagName&&"ui-model"===t.tagName.toLowerCase()&&v(t)}function l(t,a){var i=a[1],r={};a.length>2&&(r=u(a[2]));var o=m._data.$cache,s=m._data.previouslyBound,d=m.__createPath(x,i),h=e.objectPropertyByPath(g,d);n.isEmpty(r)||(h=f(h,r),e.assignValueToPath(g,d,h));var _,c,l=$(t);if(s){var p=l.findTextNodes();$.each(p,function(t,e){e.textContent===h&&(c=$(e))}),_=c&&c[0]?c[0]:m.__createTextNode(l,t,h)}else _=m.__createTextNode(l,t,h);o.set(_,{observers:d});var v=(e.observerMapPath(d),new PathObserver(g,e.observerMapPath(d)));_.bind("textContent",v);var b={type:"text",value:"textContent",node:_,path:d,observer:v};y.push(b)}function p(t,a,i){var r=a[0],o=a[1],s={};a.length>2&&(s=u(a[2]));var d,h,_=m._data.$cache,c=m.__createPath(x,o),l=e.objectPropertyByPath(g,c);n.isEmpty(s)||(l=f(l,s),e.assignValueToPath(g,c,l));var p=_.get(t);if(p?(d=p.observers,h=p.id):h=i,d&&d.length>0){var v=null;d.forEach(function(t){t.value===r&&(t.path=c,t.value_=l,v=t)}),v||(v={value:r,value_:l,path:c},d.push(v))}else d=[],v={value:r,value_:l,path:c},d.push(v),_.set(t,{observers:d,id:h});var b=(e.observerMapPath(c),new PathObserver(g,e.observerMapPath(c)));t.bind(r,b);var P={type:"attribute",value:r,node:t,path:c,observer:b};y.push(P)}function u(t){var e,n=t.match(/\((.*?)\)/g);n||(n="");var a=t.replace(n,"");return n=n.replace("(",""),n=n.replace(")",""),e=n.length<1?[]:n.split(","),{func:a,args:e}}function f(t,e){var n,a,i=e.func;return window.dust.helpers.inline[i]?(n=window.dust.helpers.inline[i],a=e.args,a.length>0?a.unshift(t):a.push(t),n.apply(this,a)):window[i]?(n=window[i],a=e.args,a.length>0?a.unshift(t):a.push(t),n.apply(this,a)):this[i]?(n=this[i],a=e.args,a.length>0?a.unshift(t):a.push(t),n.apply(this,a)):t}function v(t){var n,i,r=m._data.$cache,o=r.get(t);o&&(n=o.observers,i=o.id);var s=m.__createPath(x);try{a=e.getIndexFromPath(s)}catch(d){}r.set(t,{path:s,id:i,index:a,observers:n})}var m=this,g=this.$scope,b=0,x=[],y=this._data.pathObservers,P=this._data.templateNode;!a&&this.options.scope&&i(0,this.options.scope,null),this.__traverseDOM(t,_)},__traverseDOM:function(t,e){for(e(t),t=t.firstChild;t;)this.__traverseDOM(t,e),t=t.nextSibling},__createTextNode:function(t,e,n){t.text(t.text().replace(n,""));var a=document.createTextNode(n);return e.appendChild(a),a},__getTemplateContextArray:function(){var t=this._data.contextKeyArray;return t&&t.length>0?t[t.length-1]:[]},__createPath:function(t,e){var n="";return t.forEach(function(t){n+="undefined"!=typeof t.modelIndex?t.context+"."+t.modelIndex+".":t.context+"."}),"undefined"!=typeof e?n+=e:n=n.substring(0,n.length-1),n},__createPathByContextIndex:function(t,e,n){var a="";return t.forEach(function(t){t.index<=e&&(a+=t.context+"."+t.modelIndex+".")}),a+=n},__getCurrentContextModelPath:function(t,n,a,i){var r=this,o=this.$scope,s=n>0?n-1:0,d=[];if(a.forEach(function(n){var a=r.__createPathByContextIndex(t,s,n.context),i=e.arrayPropertyLengthByPath(o,a);d.push({length:i,context:n.context,cxt:n.cxt})}),d.length>1){for(var h={},_=0,c=0;c<d.length;c++){if(i<d[c].length+_||!d[c].length){h.modelIndex=i-_,h.context=d[c].context,h.cxt=d[c].cxt,h.index=n;break}_+=d[c].length}return h}return{modelIndex:i,context:a[0].context,cxt:a[0].cxt,index:a[0].index}},__getParentModelNode:function(t){var e=$(t).parents(this._data.modelNodeSelector);return e[0]?e[0]:this._data.templateNode[0]},__addedNodes:function(){this._data.Running||this.__isModelList()&&this.__rebind()},__removedNodes:function(t){if(!this._data.Running){for(var e,n=this.$scope,a=this,i=!1,r=0;r<t.length;r++){var o=this._data.$cache,s=t[r],d=o.get(s);if(d)e=this.__parseObservers(s,n),e&&(i=!0);else{var h=$(t).findTextNodeDescendants();h&&h.length>0&&$.each(h,function(t,r){e=a.__parseObservers(r,n),e&&(i=!0)})}}i&&this.__rebind(),this._onRemovedNodes(t)}},__parseObservers:function(t,n){var a=this._data.$cache,i=a.get(t);if("undefined"!=typeof i){var r=i.path,o=e.isPathInArray(r);return o?this.__spliceArray(n,r):e.deleteObjectPropertyByPath(n,r),!0}return!1},__spliceArray:function(t,n){var a=e.getIndexFromPath(n);if(void 0!==a){n=this.__parsePath(n,a);var i=e.objectPropertyByPath(t,n);this._data._discard=!1,this._data._setDiscardBit=!1,i.splice(a,1)}},__parsePath:function(t,e){return t.substring(0,t.length-(e.toString().length+1))},__rebind:function(){var t=this._data.templateNode;this.__unbindPathObservers(),this.__databind(t)},__onScopeChange:function(t){t.removed&&t.removed.length&&t.removed.length>0&&this.__onRemoved(t.removed),this._onScopeChange(t)},__onListRemove:function(t){function e(e){if(e.tagName&&"ui-model"===e.tagName.toLowerCase()||e.hasAttribute&&e.hasAttribute("data-node")){var a=i.get(e),r=a.index;r===t&&(e.remove(),n._data.previouslyBound=!0,n.__rebind())}}var n=this,a=this._data.templateNode[0],i=this._data.$cache;this.__traverseDOM(a,e)},__onListAdd:function(t,e,n){var a=this,i=this._compileFragment(t,e),r=this.__getParent(t,e),o="push"===n||"concat"===n?this.__getPushInsertionIndex(t,e):this.__getUnshiftInsertionIndex(t,e),s=this.__getModelFromPath(t,n),d={};d.template=i,d.model=s,d.context=e,d.parse=!1,this._renderTemplate(d,function(t,e){t||a.__insertRenderedTemplate(e,r,o)})},_compileFragment:function(t,e){var n=this.options.$providers.template,a=this._data.templateId,i=a+"-"+e,r=this.__getFragmentById(a),o="{#"+e+"}.(.*?){/"+e+"}",s=r.match(new RegExp(o,"g")),d=s.length>1?this.__getPartial(s,t,e):s[0],h=n.compile(d,i);return n.loadSource(h),i},__getModelFromPath:function(t,n){var a=this.$scope,i=e.objectPropertyByPath(a,t);return"push"===n?i[i.length-1]:"unshift"===n?i[0]:i},__getPartial:function(t,e,n){var a=n+".",i=e.match(new RegExp(a,"g")),r=i.length;return t[r-1]},__getParent:function(t){var e=t.split(".");if(e.length<2)return this._data.templateNode[0];var n=this.__getParentPath(e);return this.__getParentByPath(n)},__getParentPath:function(t){for(var e=t.length-1,n="",a=0;e>a;a++)n+=t[a]+".";return n.substring(0,n.length-1)},__getParentByPath:function(t){function e(e){if(e.tagName&&"ui-model"===e.tagName.toLowerCase()||e.hasAttribute&&e.hasAttribute("data-node")){var a=i.get(e),r=a.path;r===t&&(n=e)}}var n,a=this._data.templateNode[0],i=this._data.$cache;return this.__traverseDOM(a,e),n},__getPushInsertionIndex:function(t,n){var a=this.$scope,i=this.__getContextArrayFromPath(t),r=this.__getSectionContextProp(i,n);if(1===r.count)return-1;if(r.position===r.count-1)return-1;for(var o=t.split("."),s=this.__getParentPath(o),d=0,h=0;h<r.position+1;h++){var _=s.length&&s.length>0?s+"."+r.cxt[h]:r.cxt[h],c=e.arrayPropertyLengthByPath(a,_);d+=c}return d},__getUnshiftInsertionIndex:function(t,n){var a=this.$scope,i=this.__getContextArrayFromPath(t),r=this.__getSectionContextProp(i,n);if(1===r.count)return 0;for(var o=t.split("."),s=this.__getParentPath(o),d=0,h=0;h<r.position;h++){var _=s+"."+r.cxt[h],c=e.arrayPropertyLengthByPath(a,_);d+=c}return d},__getSectionContextProp:function(t,e){var a={};return a.count=t.length,a.cxt=t,a.position=n.indexOf(t,e),a},__getParentIndex:function(t){var e=t.split(".");return t[0]+"."+e[1]},__getContextArrayFromPath:function(t){var e=this,n=[],a=t.split(".");a.forEach(function(t){e.__isNumeric(t)||n.push(t)});var i=n.length-1,r=this.__getTemplateContextArray(),o=[];return r.forEach(function(t){t.index===i&&o.push(t.context)}),o},__isNumeric:function(t){var e=parseInt(t);return!isNaN(e)},__insertRenderedTemplate:function(t,e,n){var a,i,r=$(e),o=r.closestChildren(this._data.modelNodeSelector);i=this._fragmentModelParser(t),a=i[0];var s;-1===n?r.append(i):0===n?(s=o[0],e.insertBefore(a,s)):(s=o[n],e.insertBefore(a,s)),this.__rebind()},_fragmentModelParser:function(t){var e=this._DOMParser(t);return $(e).find("ui-model")},__onRemoved:function(t){var e=this,n=!1,a=e._data.$cache,i=this.options.idProp;void 0===i&&(i="id"),this.__isModelList()&&(t.forEach(function(t){var r=e.__templateModels();r&&r.length>0&&$.each(r,function(e,r){var o=a.get(r);void 0!==o&&void 0!==o.id?o.id===t[i]&&(r.remove(),n=!0):o&&o.observers&&o.observers.length&&o.observers.forEach(function(e){var a=t[i];"model-id"===e.value&&e.value_===a&&(r.remove(),n=!0)})})}),n&&e.__rebind())},__unbindPathObservers:function(){var t=this._data.pathObservers;t&&t.length&&t.length>0&&(t.forEach(function(t){t.observer.close()}),e.emptyArray(t))},__unbindDOMObserver:function(){var t=this._data.DOMObserver;t&&t.disconnect()},__disposeTemplate:function(){this.__unbindDOMObserver(),this.__unbindPathObservers()},__rebindTemplate:function(t){if(this._data._watched)return!1;var e;"undefined"!=typeof t&&t||(e=!0);var n=this.__getTemplateNode();return n[0]?this.__bind(e):this.options.loadedTemplate&&this.__watchForTemplateInstance(e),!0},__watchForTemplateInstance:function(t){var e=this,n=setInterval(function(){var a=e.__getTemplateNode();a[0]&&(clearInterval(n),e.__bind(t))},100)},__reconnect:function(){var t=this._data.DOMObserver;if(t){var e=this._data.templateNode;if(e[0]){var n=e[0];t.observe(n,{childList:!0,subtree:!0})}}},_printPathObservers:function(t){var e=this;void 0===t&&(t=0),setTimeout(function(){console.log(e._data.pathObservers)},t)},_getModelIdByNode:function(t){return t.getAttribute("model-id")},_getModelIdByTarget:function(t){var e=$(t),n=e.parent("ui-model");return n.attr("model-id")},_getModelNodeCache:function(t){var e=this._data.$cache;return e.get(t)},_dispose:function(){this.__disposeTemplate()},_onDOMMutation:$.noop,_onRemovedNodes:$.noop,_onScopeChange:$.noop,$deleteNodes:function(t){var e,n=this;this.__unbindPathObservers();this.$scope;t.call(this);var a=t.toString();e=a.match(/scope.(.*?).splice/g),e&&e.length&&e.forEach(function(t){t=t.replace("scope.",""),t=t.replace(".splice","");var e=a.indexOf("splice("),i=a.indexOf(",",e);e+=7;var r=a.substring(e,i),o=t+"."+r;o=o.replace(/]/g,""),o=o.replace(/[[\]]/g,"."),n.__onListRemove(o)}),e=a.match(/scope.(.*?).shift/g),e&&e.length&&e.forEach(function(t){t=t.replace("scope.",""),t=t.replace(".shift","");var e=t+".0";e=e.replace(/]/g,""),e=e.replace(/[[\]]/g,"."),n.__onListRemove(e)})},$addNodes:function(t){var e,n=this;this.__unbindPathObservers();this.$scope;t.call(this);var a=t.toString();e=a.match(/scope.(.*?).push/g),e&&e.length&&e.forEach(function(t){t=t.replace("scope.",""),t=t.replace(".push","");var e=t;e=e.replace(/]/g,""),e=e.replace(/[[\]]/g,".");var a=e.split("."),i=a[a.length-1];n.__onListAdd(e,i,"push")}),e=a.match(/scope.(.*?).unshift/g),e&&e.length&&e.forEach(function(t){t=t.replace("scope.",""),t=t.replace(".unshift","");var e=t;e=e.replace(/]/g,""),e=e.replace(/[[\]]/g,".");var a=e.split("."),i=a[a.length-1];n.__onListAdd(e,i,"unshift")}),e=a.match(/scope.(.*?).concat/g),e&&e.length&&(e=a.replace(/scope.(.*?).=/g,""),e=e.match(/scope.(.*?).concat/g),e&&e.length&&e.forEach(function(t){t=t.replace("scope.",""),t=t.replace(".concat","");var e=t;e=e.replace(/]/g,""),e=e.replace(/[[\]]/g,".");var a=e.split("."),i=a[a.length-1];n.__onListAdd(e,i,"concat")}))},$empty:function(){var t=this.__getTemplateNode();if(this.__isModelList()){var n=void 0!==this.options.scope?this.options.scope:e.objectPropertyByIndex(this.$scope,0);this.$scope[n].length=0,t.empty()}else this.$scope={},t.empty()},$unbindTemplate:function(){this.__disposeTemplate()},$rebindTemplate:function(){this.__rebindTemplate()},$renderTemplate:function(t,e){t.parse=!1,this.__renderTemplate(t,e)},$rebind:function(){if(!this._data._watched){var t=this._data.templateNode;this.__unbindPathObservers(),this.__databind(t,void 0,!0),this.__reconnect()}}}),$});